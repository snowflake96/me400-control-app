<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PID Controller</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script>
    function sendPID(kp, ki, kd, controller) {
      fetch("/set_pid", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ kp: kp, ki: ki, kd: kd, controller: controller })
      })
      .then(response => response.json())
      .then(data => {
        let statusElement = document.getElementById("status_" + controller + "_pid");
        statusElement.innerText = "PID Updated Successfully!";
        statusElement.style.color = "green";

        // Update the input fields with the new values
        document.getElementById(controller + "_kp").value = kp;
        document.getElementById(controller + "_ki").value = ki;
        document.getElementById(controller + "_kd").value = kd;

        // Message disappears after 1 second
        setTimeout(() => {
          statusElement.innerText = "";
        }, 1000);
      })
      .catch(error => {
        console.error("Error:", error);
        let statusElement = document.getElementById("status_" + controller + "_pid");
        statusElement.innerText = "Error updating PID!";
        statusElement.style.color = "red";
        // Error message disappears after 3 seconds
        setTimeout(() => {
          statusElement.innerText = "";
        }, 3000);
      });
    }

    function updatePID(controller) {
      let kp = document.getElementById(controller + "_kp").value;
      let ki = document.getElementById(controller + "_ki").value;
      let kd = document.getElementById(controller + "_kd").value;
      sendPID(kp, ki, kd, controller);
    }

    function resetPID(controller) {
      sendPID(0.0, 0.0, 0.0, controller);
    }

    function sendParams(cutoff_freq, sampling_time, integral_limit) {
      fetch("/set_params", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          cutoff_freq: cutoff_freq, 
          sampling_time: sampling_time, 
          integral_limit: integral_limit 
        })
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("status_params").innerText = "Params Updated Successfully!";
        document.getElementById("status_params").style.color = "green";

        // Update the input fields with the new values
        document.getElementById("cutoff_freq").value = cutoff_freq;
        document.getElementById("sampling_time").value = sampling_time;
        document.getElementById("integral_limit").value = integral_limit;

        // Message disappears after 1 second
        setTimeout(() => {
          document.getElementById("status_params").innerText = "";
        }, 1000);
      })
      .catch(error => {
        console.error("Error:", error);
        document.getElementById("status_params").innerText = "Error updating params!";
        document.getElementById("status_params").style.color = "red";
        // Error message disappears after 3 seconds
        setTimeout(() => {
          document.getElementById("status_params").innerText = "";
        }, 3000);
      });
    }

    function updateParams() {
      let cutoff_freq = document.getElementById("cutoff_freq").value;
      let sampling_time = document.getElementById("sampling_time").value;
      let integral_limit = document.getElementById("integral_limit").value;
      sendParams(cutoff_freq, sampling_time, integral_limit);
    }

    // Add "Enter" key listener for PID and parameter input fields.
    document.addEventListener("DOMContentLoaded", function() {
      let pidInputs = document.querySelectorAll("input[id$='_kp'], input[id$='_ki'], input[id$='_kd']");
      pidInputs.forEach(input => {
        input.addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            // The id format is "position_kp" or "velocity_kp", so the controller is the part before the underscore.
            let controller = input.id.split("_")[0];
            updatePID(controller);
          }
        });
      });
      
      let paramsInputs = document.querySelectorAll("input[id='cutoff_freq'], input[id='sampling_time'], input[id='integral_limit']");
      paramsInputs.forEach(input => {
        input.addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            updateParams();
          }
        });
      });
    });
  </script>
</head>
<body>
  <!-- Position PID Section -->
  <div class="container" id="position_pid_container">
    <h2>Position PID Gains</h2>
    <div class="input-group">
      <label for="position_kp">Kp:</label>
      <input type="number" id="position_kp" step="0.1" value="{{ pid.position.kp }}">
    </div>
    <div class="input-group">
      <label for="position_ki">Ki:</label>
      <input type="number" id="position_ki" step="0.1" value="{{ pid.position.ki }}">
    </div>
    <div class="input-group">
      <label for="position_kd">Kd:</label>
      <input type="number" id="position_kd" step="0.1" value="{{ pid.position.kd }}">
    </div>
    <button onclick="updatePID('position')">Update Position PID</button>
    <button onclick="resetPID('position')" class="reset-btn">Reset to 0</button>
    <p id="status_position_pid"></p>
  </div>

  <!-- Velocity PID Section -->
  <div class="container" id="velocity_pid_container">
    <h2>Velocity PID Gains</h2>
    <div class="input-group">
      <label for="velocity_kp">Kp:</label>
      <input type="number" id="velocity_kp" step="0.1" value="{{ pid.velocity.kp }}">
    </div>
    <div class="input-group">
      <label for="velocity_ki">Ki:</label>
      <input type="number" id="velocity_ki" step="0.1" value="{{ pid.velocity.ki }}">
    </div>
    <div class="input-group">
      <label for="velocity_kd">Kd:</label>
      <input type="number" id="velocity_kd" step="0.1" value="{{ pid.velocity.kd }}">
    </div>
    <button onclick="updatePID('velocity')">Update Velocity PID</button>
    <button onclick="resetPID('velocity')" class="reset-btn">Reset to 0</button>
    <p id="status_velocity_pid"></p>
  </div>

  <!-- Shared Parameters Section -->
  <div class="container">
    <h2>Other Parameters</h2>
    <div class="input-group">
      <label for="cutoff_freq">Cutoff Frequency:</label>
      <input type="number" id="cutoff_freq" step="0.1" value="{{ params.cutoff_freq }}">
    </div>
    <div class="input-group">
      <label for="sampling_time">Sampling Time:</label>
      <input type="number" id="sampling_time" step="0.1" value="{{ params.sampling_time }}">
    </div>
    <div class="input-group">
      <label for="integral_limit">Integral Limit:</label>
      <input type="number" id="integral_limit" step="0.1" value="{{ params.integral_limit }}">
    </div>
    <button onclick="updateParams()">Set Params</button>
    <p id="status_params"></p>
  </div>
</body>
</html>
